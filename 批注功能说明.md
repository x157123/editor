# 批注功能实现说明

## ✅ 功能已完成

已成功为 Umo Editor 添加了完整的批注功能，类似于 Microsoft Word 的批注功能。

## 🎯 如何使用

### 第一步：配置当前用户（可选）

**✨ 新特性：自动使用默认用户**

编辑器已内置默认用户，**无需任何配置即可直接使用批注功能**！启动编辑器后，即可立即开始添加批注。

**默认用户信息**：
- ID: `default-user`
- 名称: `默认用户`（中文）或 `Default User`（英文）
- 头像: 无（显示首字母 "默" 或 "D"）

**可选：自定义用户信息**

如果您想使用真实的用户信息，只需传入 `currentUser` 参数：

```vue
<umo-editor
  :comment="{
    currentUser: {
      id: 'user1',
      name: '张三',
      avatar: 'https://example.com/avatar.jpg'
    }
  }"
/>
```

### 第二步：添加批注

1. **选中文本**：在文档中选中需要添加批注的文字
2. **点击批注按钮**：
   - 点击顶部工具栏的 **"页面"** 标签
   - 找到 **"批注"** 按钮（对话气泡图标）
   - 此时按钮会从禁用变为可用状态
3. **输入批注内容**：
   - 点击批注按钮后，会弹出批注输入对话框
   - 在对话框中可以看到选中的文本
   - 输入批注内容（最多500字）
   - 点击"确定"保存批注

### 第三步：查看和管理批注

批注添加后：
- 选中的文本会有**黄色背景高亮**和**黄色下划线**标记
- 右侧会自动打开批注面板，显示所有批注
- 批注面板分为"未解决"和"已解决"两个标签

在批注面板中可以：
- 查看所有批注内容
- 点击批注项可自动定位到文档中的批注位置
- 点击"更多"菜单进行以下操作：
  - **回复**：添加回复到批注
  - **编辑**：修改批注内容
  - **解决**：标记批注为已解决
  - **重新打开**：将已解决的批注重新打开
  - **删除**：删除批注及其标记

## 📁 新增文件清单

### 核心文件
1. **`src/extensions/comment.ts`** - Tiptap 批注扩展
2. **`src/composables/comment.ts`** - 批注状态管理（Composition API）
3. **`src/components/container/comment.vue`** - 批注面板 UI 组件
4. **`src/components/menus/toolbar/page/toggle-comment.vue`** - 工具栏批注按钮
5. **`src/components/menus/toolbar/page/comment-dialog.vue`** - 批注输入对话框
6. **`src/assets/styles/comment.less`** - 批注样式
7. **`src/assets/icons/comment.svg`** - 批注图标

### 文档文件
8. **`COMMENT_FEATURE.md`** - 详细的功能文档和API说明
9. **`批注功能说明.md`** - 本文件

## 🔧 修改文件清单

1. **`types/index.d.ts`** - 添加批注相关类型定义
2. **`src/extensions/index.ts`** - 注册 Comment 扩展
3. **`src/components/index.vue`** - 添加批注状态管理
4. **`src/components/container/page.vue`** - 集成批注面板
5. **`src/components/toolbar/ribbon.vue`** - 添加批注按钮（Ribbon模式）
6. **`src/components/toolbar/classic.vue`** - 添加批注按钮（Classic模式）
7. **`src/assets/styles/index.less`** - 导入批注样式
8. **`src/locales/zh-CN.json`** - 添加中文翻译
9. **`src/locales/en-US.json`** - 添加英文翻译

## 🎨 功能特性

### 1. 批注添加
- ✅ 选中文本后点击批注按钮
- ✅ 弹出对话框输入批注内容
- ✅ 显示选中文本预览
- ✅ 批注内容最多500字
- ✅ 显示批注作者信息

### 2. 批注标记
- ✅ 黄色背景高亮
- ✅ 黄色下划线
- ✅ 批注标记点击可查看
- ✅ 批注标记可删除

### 3. 批注管理
- ✅ 查看所有批注
- ✅ 编辑批注内容
- ✅ 删除批注
- ✅ 解决批注
- ✅ 重新打开已解决的批注

### 4. 批注回复
- ✅ 对批注添加回复
- ✅ 多级回复支持
- ✅ 显示回复作者和时间

### 5. 批注导航
- ✅ 点击批注项自动定位到文档位置
- ✅ 批注列表展示
- ✅ 已解决/未解决分类显示

### 6. UI/UX
- ✅ 批注输入对话框
- ✅ 侧边栏批注面板
- ✅ 可调整面板宽度
- ✅ 暗色主题支持
- ✅ 国际化支持（中英文）
- ✅ 响应式设计
- ✅ 批注按钮智能启用（选中文本后可用）

## 🔌 配置示例

### 使用默认用户（零配置）

编辑器启动后会自动使用内置的默认用户，无需任何配置：

```vue
<template>
  <!-- 无需配置，直接使用！ -->
  <umo-editor />
</template>

<script setup>
// 无需导入或配置任何东西，批注功能已经可以使用
</script>
```

默认用户会根据当前语言自动显示：
- 中文环境：`默认用户`
- 英文环境：`Default User`

### 自定义用户配置

```vue
<template>
  <umo-editor
    :comment="{
      currentUser: {
        id: 'user1',
        name: '张三',
        avatar: 'https://example.com/avatar.jpg'
      },
      onChange: handleCommentChange,
      onResolve: handleCommentResolve,
      onDelete: handleCommentDelete
    }"
  />
</template>

<script setup>
// 批注添加/更新时触发
const handleCommentChange = (commentId, data) => {
  console.log('批注变更:', { commentId, data })
  // data 包含：content, author, createdAt, from, to
  // 可以保存到后端
}

// 批注解决时触发
const handleCommentResolve = (commentId) => {
  console.log('批注已解决:', commentId)
  // 可以更新后端状态
}

// 批注删除时触发
const handleCommentDelete = (commentId) => {
  console.log('批注已删除:', commentId)
  // 可以从后端删除
}
</script>
```

### 完整配置示例

```vue
<template>
  <umo-editor
    ref="editorRef"
    :comment="{
      enabled: true, // 启用批注功能
      currentUser: currentUser, // 当前用户信息（必填）
      onChange: saveComment,
      onResolve: resolveComment,
      onDelete: deleteComment,
      onCommentClick: viewComment // 点击批注标记时触发
    }"
  />
</template>

<script setup>
import { ref } from 'vue'

const editorRef = ref()

// 当前登录用户
const currentUser = {
  id: 'user123',
  name: '李四',
  avatar: 'https://example.com/avatar.jpg'
}

// 保存批注到后端
const saveComment = async (commentId, data) => {
  try {
    await fetch('/api/comments', {
      method: 'POST',
      body: JSON.stringify({
        commentId,
        ...data
      })
    })
  } catch (error) {
    console.error('保存批注失败:', error)
  }
}

// 解决批注
const resolveComment = async (commentId) => {
  await fetch(`/api/comments/${commentId}/resolve`, {
    method: 'PUT'
  })
}

// 删除批注
const deleteComment = async (commentId) => {
  await fetch(`/api/comments/${commentId}`, {
    method: 'DELETE'
  })
}

// 查看批注详情
const viewComment = (commentId) => {
  console.log('查看批注:', commentId)
  // 可以打开批注面板并定位到该批注
}
</script>
```

## 📝 API 说明

### Comment 扩展命令

```javascript
// 获取编辑器实例
const editor = editorRef.value.getEditor()

// 添加批注标记（通常在选中文本后调用）
editor.commands.setComment('comment-123')

// 移除批注标记
editor.commands.unsetComment('comment-123')

// 获取所有批注标记信息
const comments = editor.commands.getAllComments()
// 返回: [{ id: 'xxx', from: 0, to: 10, text: '选中的文本' }, ...]

// 定位到指定批注
editor.commands.focusComment('comment-123')

// 删除指定批注标记
editor.commands.deleteComment('comment-123')
```

### Composition API

```javascript
import { useComment } from '@/composables/comment'

const commentState = useComment(editor, currentUser)

// 可用的方法和属性
commentState.comments           // 批注数据Map
commentState.activeCommentId    // 当前激活的批注ID
commentState.currentUser        // 当前用户信息

// 批注管理方法
commentState.addComment(content, commentId)      // 添加批注
commentState.updateComment(commentId, content)   // 更新批注
commentState.deleteComment(commentId)            // 删除批注
commentState.resolveComment(commentId)           // 解决批注
commentState.reopenComment(commentId)            // 重新打开批注

// 回复管理方法
commentState.addReply(commentId, content)        // 添加回复
commentState.deleteReply(commentId, replyId)     // 删除回复

// 导航方法
commentState.setActiveComment(commentId)         // 设置活动批注

// 查询方法
commentState.getAllComments()                    // 获取所有批注
commentState.getUnresolvedComments()             // 获取未解决批注
commentState.getResolvedComments()               // 获取已解决批注

// 统计数据（计算属性）
commentState.commentCount       // 批注总数
commentState.unresolvedCount    // 未解决批注数
commentState.resolvedCount      // 已解决批注数

// 数据导入导出
commentState.exportComments()                    // 导出批注数据为JSON
commentState.importComments(jsonData)            // 导入批注数据
```

## 🚀 后续优化建议

### 功能增强
- [ ] 批注键盘快捷键支持（如 Ctrl+Alt+M）
- [ ] 批注搜索和筛选
- [ ] 批注按作者筛选
- [ ] 批注按日期排序
- [ ] 批注权限控制（只能编辑自己的批注）
- [ ] 批注@提及其他用户
- [ ] 批注附件支持

### 交互优化
- [ ] 点击批注高亮文本时显示批注详情浮层
- [ ] 批注高亮文本鼠标悬停显示预览
- [ ] 右键菜单快速添加批注
- [ ] 批注拖拽调整位置

### 协作功能
- [ ] 基于 Yjs 的实时协作批注
- [ ] 批注冲突解决
- [ ] 批注通知提醒
- [ ] 批注未读标记

### 性能优化
- [ ] 大量批注时的虚拟滚动
- [ ] 批注数据懒加载
- [ ] 批注缓存优化
- [ ] 批注标记渲染优化

### 数据管理
- [ ] 批注导出为PDF（带批注标记）
- [ ] 批注导出为Word（.docx格式）
- [ ] 批注导出为Excel（批注列表）
- [ ] 批注历史版本管理

## 💡 注意事项

1. **用户配置**：
   - ✅ **零配置启动**：编辑器启动后自动使用默认用户，无需任何配置
   - ✅ **多语言支持**：默认用户名称会根据当前语言自动切换
   - 如需自定义用户，只需设置 `comment.currentUser` 即可
   - `currentUser` 必须包含 `id` 和 `name` 字段
   - 推荐在生产环境中配置真实用户信息以便于协作

2. **选中文本**：
   - 必须先选中文本后，批注按钮才会启用
   - 未选中文本时，批注按钮为禁用状态（灰色）
   - 鼠标悬停在禁用按钮上会提示"请先选中文本"

3. **数据持久化**：
   - 批注数据仅存储在内存中，刷新页面会丢失
   - 需要通过 `onChange` 回调将批注保存到后端
   - 建议在添加批注时立即保存，避免数据丢失
   - 可使用 `exportComments()` 导出批注数据

4. **批注面板**：
   - 点击批注按钮会自动打开批注面板
   - 批注面板可以手动关闭
   - 面板宽度可以拖拽调整（280-600px）

5. **浏览器兼容**：
   - 确保浏览器支持 ES6+ 特性
   - 建议使用现代浏览器（Chrome, Firefox, Edge, Safari）

6. **样式自定义**：
   - 批注高亮颜色可通过修改 `.umo-comment` 类来自定义
   - 批注面板样式可通过修改 `.umo-comment-container` 类来自定义
   - 支持暗色主题，会自动适配

## 📚 详细文档

请查看 `COMMENT_FEATURE.md` 获取完整的技术文档和 API 说明。

## 🎉 总结

批注功能已经完全集成到 Umo Editor 中，采用类似 Microsoft Word 的交互方式，遵循项目现有的代码规范，提供了完整的类型定义、国际化支持和暗色主题适配。

### 核心特点

✅ **简单易用**：选中文本 → 点击批注按钮 → 输入内容 → 完成！
✅ **功能完善**：支持添加、编辑、回复、解决、删除批注
✅ **界面友好**：批注对话框 + 侧边栏面板，清晰直观
✅ **类型安全**：完整的 TypeScript 类型定义
✅ **国际化**：支持中英文双语
✅ **主题适配**：支持亮色和暗色主题
✅ **代码规范**：遵循项目 BEM 命名规范和代码风格

### 快速开始

**零配置使用（推荐用于快速体验）：**

```vue
<template>
  <umo-editor />
</template>
```

**生产环境配置（推荐用于实际项目）：**

```vue
<template>
  <umo-editor
    :comment="{
      currentUser: {
        id: 'user1',
        name: '张三',
        avatar: 'https://example.com/avatar.jpg'
      }
    }"
  />
</template>
```

**使用步骤：**
1. 选中文本
2. 点击"页面"→"批注"按钮
3. 输入批注内容
4. 开始协作！

### 技术支持

- 📖 完整文档：`COMMENT_FEATURE.md`
- 🐛 问题反馈：项目 Issue
- 💬 功能建议：欢迎提交 PR

如有任何问题或建议，欢迎反馈！
